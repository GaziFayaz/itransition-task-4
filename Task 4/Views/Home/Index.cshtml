@using System.Security.Claims
@model List<Task_4.Models.User>
@{
    ViewData["Title"] = "User Management";
}

<form asp-action="Index" method="post">
    @Html.AntiForgeryToken()
</form>

<div class="container-fluid py-4">
    <h2 class="mb-4">User Management</h2>

    <!-- Action Buttons -->
    <div class="mb-3">
        <button id="blockBtn" class="btn btn-warning me-2" disabled>
            <i class="bi bi-lock-fill"></i> Block
        </button>
        <button id="unblockBtn" class="btn btn-success me-2" disabled>
            <i class="bi bi-unlock-fill"></i> Unblock
        </button>
        <button id="deleteBtn" class="btn btn-danger me-2" disabled>
            <i class="bi bi-trash-fill"></i> Delete
        </button>
        @{
            var currentUserId = int.Parse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "0");
            var currentUser = Model.FirstOrDefault(u => u.Id == currentUserId);
            if (currentUser != null && currentUser.Status == Task_4.Models.Status.Unverified)
            {
                <button id="verifyBtn" class="btn btn-primary me-2">
                    <i class="bi bi-check-circle-fill"></i> Verify Me
                </button>
            }
        }
        <a href="/Auth/Logout" class="btn btn-secondary">
            <i class="bi bi-box-arrow-right"></i> Logout
        </a>
    </div>

    <!-- Users Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <th style="width: 50px;">
                    <input type="checkbox" id="selectAll" class="form-check-input">
                </th>
                <th>Name</th>
                <th>Email</th>
                <th>Status</th>
                <th>Last Activity</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var user in Model)
            {
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input user-checkbox"
                               data-user-id="@user.Id"
                               data-user-status="@user.Status">
                    </td>
                    <td>@user.Name</td>
                    <td>@user.Email</td>
                    <td>
                        @if (user.Status == Task_4.Models.Status.Blocked)
                        {
                            <span class="badge bg-danger">Blocked</span>
                        }
                        else if (user.Status == Task_4.Models.Status.Verified)
                        {
                            <span class="badge bg-success">Verified</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Unverified</span>
                        }
                    </td>
                    <td>
                        @if (user.LastActivityAt.HasValue)
                        {
                            @user.LastActivityAt.Value.ToLocalTime().ToString("g")
                        }
                        else
                        {
                            <span class="text-muted">Never</span>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Select/Deselect All
            $('#selectAll').on('change', function () {
                $('.user-checkbox').prop('checked', this.checked);
                updateButtonStates();
            });

            // Individual checkbox change
            $('.user-checkbox').on('change', function () {
                updateSelectAllCheckbox();
                updateButtonStates();
            });

            function updateSelectAllCheckbox() {
                const totalCheckboxes = $('.user-checkbox').length;
                const checkedCheckboxes = $('.user-checkbox:checked').length;
                $('#selectAll').prop('checked', totalCheckboxes === checkedCheckboxes && totalCheckboxes > 0);
            }

            function updateButtonStates() {
                const selectedCheckboxes = $('.user-checkbox:checked');
                const selectedCount = selectedCheckboxes.length;

                if (selectedCount === 0) {
                    $('#blockBtn, #unblockBtn, #deleteBtn').prop('disabled', true);
                    return;
                }

                // Enable delete button if any users selected
                $('#deleteBtn').prop('disabled', false);

                // Check status of selected users
                let hasBlocked = false;
                let hasNonBlocked = false;

                selectedCheckboxes.each(function () {
                    const status = $(this).data('user-status');
                    console.log($(this).data('user-status'));
                    if (status === "Blocked") { // Blocked
                        hasBlocked = true;
                    } else {
                        hasNonBlocked = true;
                    }
                });

                // Enable/disable block/unblock buttons based on selection
                $('#blockBtn').prop('disabled', !hasNonBlocked);
                $('#unblockBtn').prop('disabled', !hasBlocked);
            }

            // Block button click
            $('#blockBtn').on('click', function () {
                const selectedIds = getSelectedUserIds();
                if (selectedIds.length > 0) {
                    performAction('/Home/BlockUsers', selectedIds, 'block');
                }
            });

            // Unblock button click
            $('#unblockBtn').on('click', function () {
                const selectedIds = getSelectedUserIds();
                if (selectedIds.length > 0) {
                    performAction('/Home/UnblockUsers', selectedIds, 'unblock');
                }
            });

            // Delete button click
            $('#deleteBtn').on('click', function () {
                const selectedIds = getSelectedUserIds();
                if (selectedIds.length > 0) {
                    if (confirm(`Are you sure you want to delete ${selectedIds.length} user(s)?`)) {
                        performAction('/Home/DeleteUsers', selectedIds, 'delete');
                    }
                }
            });

            // Verify button click
            $('#verifyBtn').on('click', function () {
                const form = $('<form>', {
                    method: 'POST',
                    action: '/Home/VerifyMe'
                });

                const token = $('input[name="__RequestVerificationToken"]').val();
                if (token) {
                    form.append($('<input>', {
                        type: 'hidden',
                        name: '__RequestVerificationToken',
                        value: token
                    }));
                }

                $('body').append(form);
                form.submit();
            });

            function performAction(url, userIds, action) {
                // Create a form and submit to allow redirect with TempData
                const form = $('<form>', {
                    method: 'POST',
                    action: url
                });

                // Add anti-forgery token
                const token = $('input[name="__RequestVerificationToken"]').val();
                if (token) {
                    form.append($('<input>', {
                        type: 'hidden',
                        name: '__RequestVerificationToken',
                        value: token
                    }));
                }

                // Add user IDs as form data
                userIds.forEach(function (id, index) {
                    form.append($('<input>', {
                        type: 'hidden',
                        name: `userIds[${index}]`,
                        value: id
                    }));
                });

                // Append form to body and submit
                $('body').append(form);
                form.submit();
            }

            function getSelectedUserIds() {
                return $('.user-checkbox:checked').map(function () {
                    return $(this).data('user-id');
                }).get();
            }
        });
    </script>
}
